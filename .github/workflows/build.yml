name: Build Kava

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [ created ]

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
      - shell: cmd
        env:
          KAVA_METADATA: ${{ secrets.KAVA_METADATA }}
        run: |
          if not "%KAVA_METADATA%"=="" (
            mkdir art\buildScripts 2>nul
            echo %KAVA_METADATA% > metadata.b64
            certutil -decode metadata.b64 art\buildScripts\metadata.txt
            del metadata.b64
          )
      - shell: cmd
        run: |
          cd src
          python -m PyInstaller ^
            --onefile ^
            --name Kava ^
            --icon ..\art\Icon.ico ^
            --version-file ..\art\buildScripts\metadata.txt ^
            Interp.py
      - uses: actions/upload-artifact@v4
        with:
          name: Kava-Windows
          path: src/dist/Kava.exe

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
      - env:
          KAVA_METADATA: ${{ secrets.KAVA_METADATA }}
        run: |
          if [ -n "$KAVA_METADATA" ]; then
            mkdir -p art/buildScripts
            echo "$KAVA_METADATA" | base64 --decode > art/buildScripts/metadata.txt
          fi
      - run: |
          cd src
          pyinstaller --onefile --name Kava Interp.py
      - uses: actions/upload-artifact@v4
        with:
          name: Kava-Linux
          path: src/dist/Kava

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: |
          python3 -m pip install --upgrade pip
          pip3 install pyinstaller
      - env:
          KAVA_METADATA: ${{ secrets.KAVA_METADATA }}
        run: |
          if [ -n "$KAVA_METADATA" ]; then
            mkdir -p art/buildScripts
            echo "$KAVA_METADATA" | base64 --decode > art/buildScripts/metadata.txt
          fi
      - run: |
          cd src
          pyinstaller --onefile --name Kava Interp.py
      - uses: actions/upload-artifact@v4
        with:
          name: Kava-macOS
          path: src/dist/Kava
